<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Session.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Session.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import partition from 'lodash/collection/partition';

/**
 * Session handles a single
 * action dispatch.
 */
const Session = class Session {
    /**
     * Creates a new Session.
     *
     * @param  {Schema} schema - a Schema instance
     * @param  {Object} state - the database state
     * @param  {Object} [action] - the current action in the dispatch cycle.
     *                             Will be passed to the user defined reducers.
     */
    constructor(models, state, action) {
        this.action = action;
        this.state = state;

        this.models = models;

        this.updates = [];

        models.forEach(modelClass => {
            Object.defineProperty(this, modelClass.modelName, {
                get: () => modelClass,
            });

            modelClass.connect(this);
        });
    }

    /**
     * Records an update to the session.
     * @param {Object} update - the update object. Must have keys
     *                            `type`, `payload` and `meta`. `meta`
     *                            must also include a `name` attribute
     *                            that contains the model name.
     */
    addUpdate(update) {
        this.updates.push(update);
    }

    /**
     * Gets the recorded updates for `modelClass` and
     * deletes them from the Session instance updates list.
     *
     * @param  {Model} modelClass - the model class to get updates for
     * @return {Object[]} A list of the user-recorded updates for `modelClass`.
     */
    getUpdatesFor(modelClass) {
        const [updates, other] = partition(
            this.updates,
            'meta.name',
            modelClass.modelName);

        this.updates = other;
        return updates;
    }

    getDefaultState() {
        const state = {};
        this.models.forEach(modelClass => {
            state[modelClass.modelName] = modelClass.getDefaultState();
        });
        return state;
    }

    getState(modelName) {
        if (this.state) {
            return this.state[modelName];
        }
        return undefined;
    }

    /**
     * Calls the user defined reducers and returns
     * the next state.
     * @return {Object} The next state
     */
    reduce() {
        this.updates = [];
        const nextState = {};

        this.models.forEach(modelClass => {
            nextState[modelClass.modelName] = modelClass.callUserReducer();
        });
        // The remaining updates are for M2M tables.
        return this.updates.reduce((state, action) => {
            const modelName = action.meta.name;
            state[modelName] = this[modelName].getNextState();
            return state;
        }, nextState);
    }
};

export default Session;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="Backend.html">Backend</a></li><li><a href="Model.html">Model</a></li><li><a href="module-utils-ListIterator.html">ListIterator</a></li><li><a href="QuerySet.html">QuerySet</a></li><li><a href="Schema.html">Schema</a></li><li><a href="Session.html">Session</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Dec 12 2015 16:34:06 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
